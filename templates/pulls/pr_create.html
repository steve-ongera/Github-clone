{% extends 'base.html' %}

{% block title %}Pull requests · {{ repo.owner.username }}/{{ repo.name }}{% endblock %}

{% block content %}
<div class="d-flex flex-between flex-center mb-3">
    <div>
        <h2><a href="{% url 'repo_detail' repo.owner.username repo.name %}">{{ repo.owner.username }}/{{ repo.name }}</a></h2>
    </div>
</div>

<div class="tabnav">
    <a href="{% url 'repo_detail' repo.owner.username repo.name %}" class="tabnav-tab">
        <i class="bi bi-code-slash"></i>
        Code
    </a>
    <a href="{% url 'issue_list' repo.owner.username repo.name %}" class="tabnav-tab">
        <i class="bi bi-circle-fill" style="font-size: 8px;"></i>
        Issues
        <span class="counter">{{ repo.open_issues_count }}</span>
    </a>
    <a href="{% url 'pr_list' repo.owner.username repo.name %}" class="tabnav-tab selected">
        <i class="bi bi-git"></i>
        Pull requests
    </a>
</div>

<div class="card">
    <div class="card-header d-flex flex-between flex-center">
        <div class="d-flex gap-2">
            <a href="?state=open" class="btn btn-sm {% if current_state == 'open' %}btn-primary{% else %}btn-secondary{% endif %}">
                <i class="bi bi-git"></i>
                Open
            </a>
            <a href="?state=closed" class="btn btn-sm {% if current_state == 'closed' %}btn-primary{% else %}btn-secondary{% endif %}">
                <i class="bi bi-x-circle"></i>
                Closed
            </a>
            <a href="?state=merged" class="btn btn-sm {% if current_state == 'merged' %}btn-primary{% else %}btn-secondary{% endif %}">
                <i class="bi bi-check-circle"></i>
                Merged
            </a>
        </div>
        
        {% if user.is_authenticated %}
        <a href="{% url 'pr_create' repo.owner.username repo.name %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg"></i>
            New pull request
        </a>
        {% endif %}
    </div>
    
    <div class="list-group">
        {% for pr in prs %}
        <div class="list-item">
            <div style="flex: 1;">
                <div class="d-flex flex-center gap-2 mb-1">
                    {% if pr.state == 'open' %}
                    <i class="bi bi-git" style="font-size: 14px; color: #3fb950;"></i>
                    {% elif pr.state == 'merged' %}
                    <i class="bi bi-check-circle-fill" style="font-size: 14px; color: #a371f7;"></i>
                    {% else %}
                    <i class="bi bi-x-circle-fill" style="font-size: 14px; color: #f85149;"></i>
                    {% endif %}
                    <a href="{% url 'pr_detail' repo.owner.username repo.name pr.number %}" class="text-bold">
                        {{ pr.title }}
                    </a>
                    {% if pr.draft %}
                    <span class="label">
                        Draft
                    </span>
                    {% endif %}
                </div>
                <div class="text-muted text-small">
                    #{{ pr.number }} by 
                    <a href="{% url 'profile' pr.author.username %}">{{ pr.author.username }}</a>
                    was {{ pr.state }}
                    {% if pr.state == 'merged' and pr.merged_at %}
                    {{ pr.merged_at|timesince }} ago
                    {% else %}
                    {{ pr.created_at|timesince }} ago
                    {% endif %}
                    {% if pr.comments_count > 0 %}
                    · <i class="bi bi-chat-left"></i> {{ pr.comments_count }}
                    {% endif %}
                </div>
            </div>
            <div class="d-flex flex-center gap-3">
                {% if pr.reviews.all %}
                <div class="d-flex flex-center gap-1">
                    {% for review in pr.reviews.all|slice:":3" %}
                    <div class="avatar" style="width: 20px; height: 20px; font-size: 10px;">
                        {{ review.reviewer.username|slice:":2"|upper }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="list-item text-center">
            <div style="padding: 40px;">
                <i class="bi bi-git" style="font-size: 48px; color: var(--color-fg-muted);"></i>
                <h3 class="mt-3">No {{ current_state }} pull requests</h3>
                {% if user.is_authenticated and current_state == 'open' %}
                <a href="{% url 'pr_create' repo.owner.username repo.name %}" class="btn btn-primary mt-2">
                    <i class="bi bi-plus-lg"></i>
                    Create your first pull request
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% if prs.has_other_pages %}
<div class="d-flex flex-between flex-center mt-3">
    <div>
        {% if prs.has_previous %}
        <a href="?page={{ prs.previous_page_number }}&state={{ current_state }}" class="btn btn-secondary">
            <i class="bi bi-chevron-left"></i>
            Previous
        </a>
        {% endif %}
    </div>
    <div class="text-muted">
        Page {{ prs.number }} of {{ prs.paginator.num_pages }}
    </div>
    <div>
        {% if prs.has_next %}
        <a href="?page={{ prs.next_page_number }}&state={{ current_state }}" class="btn btn-secondary">
            Next
            <i class="bi bi-chevron-right"></i>
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

{% endblock %}